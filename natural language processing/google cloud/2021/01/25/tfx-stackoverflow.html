<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>TFX: ejemplo con un dataset de Stack Overflow con InteractiveContext | Blog práctico de Aprendizaje Profundo en Español</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="TFX: ejemplo con un dataset de Stack Overflow con InteractiveContext" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Ejemplo sencillo de TFX con un dataset de posts de Stack Overflow con InteractiveContext." />
<meta property="og:description" content="Ejemplo sencillo de TFX con un dataset de posts de Stack Overflow con InteractiveContext." />
<link rel="canonical" href="https://rafaelsf80.github.io/notebooks/natural%20language%20processing/google%20cloud/2021/01/25/tfx-stackoverflow.html" />
<meta property="og:url" content="https://rafaelsf80.github.io/notebooks/natural%20language%20processing/google%20cloud/2021/01/25/tfx-stackoverflow.html" />
<meta property="og:site_name" content="Blog práctico de Aprendizaje Profundo en Español" />
<meta property="og:image" content="https://rafaelsf80.github.io/notebooks/images/tfx.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-25T00:00:00-06:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://rafaelsf80.github.io/notebooks/natural%20language%20processing/google%20cloud/2021/01/25/tfx-stackoverflow.html"},"description":"Ejemplo sencillo de TFX con un dataset de posts de Stack Overflow con InteractiveContext.","@type":"BlogPosting","url":"https://rafaelsf80.github.io/notebooks/natural%20language%20processing/google%20cloud/2021/01/25/tfx-stackoverflow.html","headline":"TFX: ejemplo con un dataset de Stack Overflow con InteractiveContext","dateModified":"2021-01-25T00:00:00-06:00","datePublished":"2021-01-25T00:00:00-06:00","image":"https://rafaelsf80.github.io/notebooks/images/tfx.png","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/notebooks/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://rafaelsf80.github.io/notebooks/feed.xml" title="Blog práctico de Aprendizaje Profundo en Español" /><link rel="shortcut icon" type="image/x-icon" href="/notebooks/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>TFX: ejemplo con un dataset de Stack Overflow con InteractiveContext | Blog práctico de Aprendizaje Profundo en Español</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="TFX: ejemplo con un dataset de Stack Overflow con InteractiveContext" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Ejemplo sencillo de TFX con un dataset de posts de Stack Overflow con InteractiveContext." />
<meta property="og:description" content="Ejemplo sencillo de TFX con un dataset de posts de Stack Overflow con InteractiveContext." />
<link rel="canonical" href="https://rafaelsf80.github.io/notebooks/natural%20language%20processing/google%20cloud/2021/01/25/tfx-stackoverflow.html" />
<meta property="og:url" content="https://rafaelsf80.github.io/notebooks/natural%20language%20processing/google%20cloud/2021/01/25/tfx-stackoverflow.html" />
<meta property="og:site_name" content="Blog práctico de Aprendizaje Profundo en Español" />
<meta property="og:image" content="https://rafaelsf80.github.io/notebooks/images/tfx.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-25T00:00:00-06:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://rafaelsf80.github.io/notebooks/natural%20language%20processing/google%20cloud/2021/01/25/tfx-stackoverflow.html"},"description":"Ejemplo sencillo de TFX con un dataset de posts de Stack Overflow con InteractiveContext.","@type":"BlogPosting","url":"https://rafaelsf80.github.io/notebooks/natural%20language%20processing/google%20cloud/2021/01/25/tfx-stackoverflow.html","headline":"TFX: ejemplo con un dataset de Stack Overflow con InteractiveContext","dateModified":"2021-01-25T00:00:00-06:00","datePublished":"2021-01-25T00:00:00-06:00","image":"https://rafaelsf80.github.io/notebooks/images/tfx.png","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://rafaelsf80.github.io/notebooks/feed.xml" title="Blog práctico de Aprendizaje Profundo en Español" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/notebooks/">Blog práctico de Aprendizaje Profundo en Español</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/notebooks/about/">About Me</a><a class="page-link" href="/notebooks/search/">Search</a><a class="page-link" href="/notebooks/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">TFX: ejemplo con un dataset de Stack Overflow con InteractiveContext</h1><p class="page-description">Ejemplo sencillo de TFX con un dataset de posts de Stack Overflow con InteractiveContext.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-01-25T00:00:00-06:00" itemprop="datePublished">
        Jan 25, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      17 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/notebooks/categories/#Natural language processing">Natural language processing</a>
        &nbsp;
      
        <a class="category-tags-link" href="/notebooks/categories/#Google Cloud">Google Cloud</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/rafaelsf80/notebooks/tree/master/_notebooks/2021-01-25-tfx-stackoverflow.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/notebooks/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/rafaelsf80/notebooks/master?filepath=_notebooks%2F2021-01-25-tfx-stackoverflow.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/notebooks/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/rafaelsf80/notebooks/blob/master/_notebooks/2021-01-25-tfx-stackoverflow.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/notebooks/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#1.-Introducción">1. Introducción </a></li>
<li class="toc-entry toc-h2"><a href="#2.-Setup">2. Setup </a></li>
<li class="toc-entry toc-h2"><a href="#3.-Carga-de-datos">3. Carga de datos </a></li>
<li class="toc-entry toc-h2"><a href="#4.-Ejecución-interactiva-de-los-componentes-TFX-individuales">4. Ejecución interactiva de los componentes TFX individuales </a>
<ul>
<li class="toc-entry toc-h3"><a href="#ExampleGen">ExampleGen </a></li>
<li class="toc-entry toc-h3"><a href="#StatisticsGen">StatisticsGen </a></li>
<li class="toc-entry toc-h3"><a href="#SchemaGen">SchemaGen </a></li>
<li class="toc-entry toc-h3"><a href="#ExampleValidator">ExampleValidator </a></li>
<li class="toc-entry toc-h3"><a href="#Transform">Transform </a></li>
<li class="toc-entry toc-h3"><a href="#Trainer">Trainer </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Analyze-Training-with-TensorBoard">Analyze Training with TensorBoard </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Evaluator">Evaluator </a></li>
<li class="toc-entry toc-h3"><a href="#Pusher">Pusher </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-01-25-tfx-stackoverflow.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="1.-Introducción">
<a class="anchor" href="#1.-Introducci%C3%B3n" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. Introducción<a class="anchor-link" href="#1.-Introducci%C3%B3n"> </a>
</h2>
<p>Este notebook implementa una ejecución interactiva de los componentes individuales de un pipeline de TensorFlow Extended (TFX). TFX es una plataforma extremo a extremo para el despliegue de modelos de ML en producción. En TFX se define un DAG con una serie de componentes, muchos de las cuales están definidas por el propio TFX. Los componentes implementados son los principales usados desde la ingestión a la puesta del modelo en servicio en producción. Se usa Keras y TensorFlow 2.</p>
<p>Se pueden usar los componentes estándar de TFX y sus dependencias entre ellos (es decir, qué componente es continuación de otro), ó bien que el desarrollador defina las dependencias con <code>add_downstream_node / add_upstream_node</code>(disponible en cada componente, pej en el componente <a href="https://www.tensorflow.org/tfx/api_docs/python/tfx/components/Trainer#add_downstream_node">Trainer</a>). Nótese que <strong>algunas dependencias son implícitas</strong>, pej: el componente <a href="https://www.tensorflow.org/tfx/guide/pusher">Pusher</a> va siempre después de <a href="https://www.tensorflow.org/tfx/guide/trainer">Trainer</a>.</p>
<p>Se puede leer la historia de TFX <a href="https://blog.tensorflow.org/2020/09/brief-history-of-tensorflow-extended-tfx.html">aqui</a>.</p>
<p>TFX implementa componentes estándar y las librerías Python para usarlas, las cuales están ya implementadas y listas para usar.</p>
<p><strong>Ejecución:</strong> TFX permite la ejecución en orquestradores como Apache Airflow, Kubeflow Pipelines ó Apache Beam. En este notebook el orquestrador será el propio Notebook ya que se va a usar un entorno interactivo.</p>
<p><strong>Metadatos:</strong> en un entorno en producción, los metadatos se almacenan con el ML Metadata (MLMD) API. MLMD almacena las propiedades de los metadatos en una base de datos comom MySQL ó SQLite, y el contenido en almacenamiento persistente como un disco duro. En en notebook interactico, ambas propiedades y contenido de los metadatos se almacenan los almacena en el directorio <code>/tmp</code> del notebook.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="2.-Setup">
<a class="anchor" href="#2.-Setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. Setup<a class="anchor-link" href="#2.-Setup"> </a>
</h2>
<p>Importamos los paquetes necesarios, incluyendo los componentes estándar de TFX.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> <span class="c1"># OPCIONAL: en caso de usar Colab</span>
 <span class="o">!</span>pip3 install tfx
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> <span class="c1"># OPCIONAL: Restart Colab runtime after installing TFX</span>
 <span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">auth</span> <span class="k">as</span> <span class="n">google_auth</span>
 <span class="n">google_auth</span><span class="o">.</span><span class="n">authenticate_user</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ModuleNotFoundError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-8c3cba8104c1&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> <span class="ansi-red-fg"># OPCIONAL: Restart Colab runtime after installing TFX</span>
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> google<span class="ansi-blue-fg">.</span>colab <span class="ansi-green-fg">import</span> auth <span class="ansi-green-fg">as</span> google_auth
<span class="ansi-green-intense-fg ansi-bold">      3</span> google_auth<span class="ansi-blue-fg">.</span>authenticate_user<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">ModuleNotFoundError</span>: No module named 'google.colab'</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># OPCIONAL: en caso de usar AI Platform Notebooks</span>
<span class="c1">#!gcloud auth login</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">urllib</span>

<span class="kn">import</span> <span class="nn">absl</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_model_analysis</span> <span class="k">as</span> <span class="nn">tfma</span>
<span class="n">tf</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">tfx</span>
<span class="kn">from</span> <span class="nn">tfx.components</span> <span class="kn">import</span> <span class="n">CsvExampleGen</span>
<span class="kn">from</span> <span class="nn">tfx.components</span> <span class="kn">import</span> <span class="n">Evaluator</span>
<span class="kn">from</span> <span class="nn">tfx.components</span> <span class="kn">import</span> <span class="n">ExampleValidator</span>
<span class="kn">from</span> <span class="nn">tfx.components</span> <span class="kn">import</span> <span class="n">Pusher</span>
<span class="kn">from</span> <span class="nn">tfx.components</span> <span class="kn">import</span> <span class="n">ResolverNode</span>
<span class="kn">from</span> <span class="nn">tfx.components</span> <span class="kn">import</span> <span class="n">SchemaGen</span>
<span class="kn">from</span> <span class="nn">tfx.components</span> <span class="kn">import</span> <span class="n">StatisticsGen</span>
<span class="kn">from</span> <span class="nn">tfx.components</span> <span class="kn">import</span> <span class="n">Trainer</span>
<span class="kn">from</span> <span class="nn">tfx.components</span> <span class="kn">import</span> <span class="n">Transform</span>
<span class="kn">from</span> <span class="nn">tfx.components.base</span> <span class="kn">import</span> <span class="n">executor_spec</span>
<span class="kn">from</span> <span class="nn">tfx.components.trainer.executor</span> <span class="kn">import</span> <span class="n">GenericExecutor</span>
<span class="kn">from</span> <span class="nn">tfx.dsl.experimental</span> <span class="kn">import</span> <span class="n">latest_blessed_model_resolver</span>
<span class="kn">from</span> <span class="nn">tfx.orchestration</span> <span class="kn">import</span> <span class="n">metadata</span>
<span class="kn">from</span> <span class="nn">tfx.orchestration</span> <span class="kn">import</span> <span class="n">pipeline</span>
<span class="kn">from</span> <span class="nn">tfx.orchestration.experimental.interactive.interactive_context</span> <span class="kn">import</span> <span class="n">InteractiveContext</span>
<span class="kn">from</span> <span class="nn">tfx.proto</span> <span class="kn">import</span> <span class="n">pusher_pb2</span>
<span class="kn">from</span> <span class="nn">tfx.proto</span> <span class="kn">import</span> <span class="n">trainer_pb2</span>
<span class="kn">from</span> <span class="nn">tfx.types</span> <span class="kn">import</span> <span class="n">Channel</span>
<span class="kn">from</span> <span class="nn">tfx.types.standard_artifacts</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">tfx.types.standard_artifacts</span> <span class="kn">import</span> <span class="n">ModelBlessing</span>
<span class="kn">from</span> <span class="nn">tfx.utils.dsl_utils</span> <span class="kn">import</span> <span class="n">external_input</span>


<span class="o">%</span><span class="k">load_ext</span> tfx.orchestration.experimental.interactive.notebook_extensions.skip
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>WARNING:absl:RuntimeParameter is only supported on Cloud-based DAG runner currently.
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Comprobamos versiones de TF y TFX:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">'TensorFlow version: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'TFX version: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tfx</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>TensorFlow version: 2.4.1
TFX version: 0.27.0
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Set up logging.</span>
<span class="n">absl</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">absl</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Activamos <code>InteractiveContext</code>, lo cual nos permite que el notebook sea el orquestrador y ejecutar los componentes TFX en el propio notebook. <code>InteractiveContext</code> es una forma más rápida de usar TFX en un notebook, hacer depuración y fue <a href="https://blog.tensorflow.org/2019/11/introducing-tfx-interactive-notebook.html">lanzado en 2019</a>.</p>
<p>Es decir, en este notebook, instanciamos los componentes uno a uno con <code>InteractiveContext.run()</code> y se ejecutan en el notebook. En un sistema en producción, los componentes se deben definir dentro de la clase <code>Pipeline</code> y se ejecutan en el orquestrador (véase <a href="../tfx/guide/build_tfx_pipeline">Building a TFX Pipeline Guide</a>).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Here, we create an InteractiveContext using default parameters. This will</span>
<span class="c1"># use a temporary directory with an ephemeral ML Metadata database instance.</span>
<span class="c1"># To use your own pipeline root or database, the optional properties</span>
<span class="c1"># `pipeline_root` and `metadata_connection_config` may be passed to</span>
<span class="c1"># InteractiveContext. Calls to InteractiveContext are no-ops outside of the</span>
<span class="c1"># notebook.</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">InteractiveContext</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>WARNING:absl:InteractiveContext pipeline_root argument not provided: using temporary directory /var/folders/sr/1jd3j8k5791g_37qk2vdcc_80069vh/T/tfx-interactive-2021-04-03T16_45_34.079859-3hgwznh2 as root for pipeline outputs.
WARNING:absl:InteractiveContext metadata_connection_config not provided: using SQLite ML Metadata database at /var/folders/sr/1jd3j8k5791g_37qk2vdcc_80069vh/T/tfx-interactive-2021-04-03T16_45_34.079859-3hgwznh2/metadata.sqlite.
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="3.-Carga-de-datos">
<a class="anchor" href="#3.-Carga-de-datos" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. Carga de datos<a class="anchor-link" href="#3.-Carga-de-datos"> </a>
</h2>
<p>Descargamos el dataset de posts de Stack Overflow y convertimos a formato <code>TFRecord</code> antes de iniciar el pipeline:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">def</span> <span class="nf">create_tf_example</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>

    <span class="n">tf_example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Features</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">'text'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">bytes_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">BytesList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)])),</span>
        <span class="s1">'label'</span><span class="p">:</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">label</span><span class="p">])),</span>
        <span class="c1">#'Label': tf.train.Feature(bytes_list=tf.train.BytesList(value=[label.encode('utf-8')])),</span>
    <span class="p">}))</span>
    <span class="k">return</span> <span class="n">tf_example</span>

<span class="n">data_url</span> <span class="o">=</span> <span class="s1">'https://storage.googleapis.com/download.tensorflow.org/data/stack_overflow_16k.tar.gz'</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span>
    <span class="s1">'stack_overflow_16k.tar.gz'</span><span class="p">,</span>
    <span class="n">data_url</span><span class="p">,</span>
    <span class="n">untar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="o">=</span><span class="s1">'stack_overflow'</span><span class="p">,</span>
    <span class="n">cache_subdir</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
<span class="n">dataset_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>

<span class="c1"># Read train data as TFRecords</span>
<span class="n">labels_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'java'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'python'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'csharp'</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'javascript'</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dataset_dir</span><span class="o">/</span><span class="s1">'train/stackoverflow-train.tfrecords'</span><span class="p">))</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">train_directory</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dataset_dir</span><span class="o">/</span><span class="s1">'train/java'</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="o">/</span><span class="s1">'train/python'</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="o">/</span><span class="s1">'train/csharp'</span><span class="p">,</span> <span class="n">dataset_dir</span><span class="o">/</span><span class="s1">'train/javascript'</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Generating: TRAIN "</span><span class="p">,</span><span class="n">train_directory</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">" "</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">train_directory</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">'*'</span><span class="p">))))</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">train_directory</span><span class="p">)</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">myfile</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span>
                <span class="n">myfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1"># data: text; labels: int64, according to labels_dict</span>
            <span class="n">example</span> <span class="o">=</span> <span class="n">create_tf_example</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels_dict</span><span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">train_directory</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">])</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Downloading data from https://storage.googleapis.com/download.tensorflow.org/data/stack_overflow_16k.tar.gz
6053888/6053168 [==============================] - 0s 0us/step
Generating: TRAIN  java   2000
Generating: TRAIN  python   2000
Generating: TRAIN  csharp   2000
Generating: TRAIN  javascript   2000
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="4.-Ejecución-interactiva-de-los-componentes-TFX-individuales">
<a class="anchor" href="#4.-Ejecuci%C3%B3n-interactiva-de-los-componentes-TFX-individuales" aria-hidden="true"><span class="octicon octicon-link"></span></a>4. Ejecución interactiva de los componentes TFX individuales<a class="anchor-link" href="#4.-Ejecuci%C3%B3n-interactiva-de-los-componentes-TFX-individuales"> </a>
</h2>
<p>En las siguientes celdas, se van a ejecutar los componentes de TFX uno a uno, y se visualizarán algunos artifacts de salida.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="ExampleGen">
<a class="anchor" href="#ExampleGen" aria-hidden="true"><span class="octicon octicon-link"></span></a>ExampleGen<a class="anchor-link" href="#ExampleGen"> </a>
</h3>
<p>El componente <code>ExampleGen</code> es normalmente el <strong>primero del pipeline de TFX</strong>. Genera datos para otros componentes como <code>SchemaGen</code>, <code>StatisticsGen</code>, <code>Transform</code> y otros.Permite leer de CSV, tf.record y Bigquery, pero se podría crear un executor para leer de Avro ó parque. Puede hacer un split de train/eval, ó importar el que ya esté hecho.</p>
<p>Funciones:</p>
<ol>
<li>Realiza split de datos en entrenamiento y evaluación (por defecto, 2/3 entrenamiento + 1/3 evaluación)</li>
<li>Convierte datos en formato <code>tf.Example</code> </li>
<li>Copia datos en el directorio <code>_tfx_root</code> para que accedan otros componentes</li>
</ol>
<p><code>ExampleGen</code> takes as input the path to your data source. In our case, this is the <code>_data_root</code> path that contains the downloaded CSV.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">tfx.components.example_gen.import_example_gen.component</span> <span class="kn">import</span> <span class="n">ImportExampleGen</span>
<span class="kn">from</span> <span class="nn">tfx.proto</span> <span class="kn">import</span> <span class="n">example_gen_pb2</span>


<span class="n">path_to_tfrecord_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataset_dir</span><span class="o">/</span><span class="s1">'train'</span><span class="p">)</span>

<span class="c1"># Output 2 splits: train:eval=3:1.</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">example_gen_pb2</span><span class="o">.</span><span class="n">Output</span><span class="p">(</span>
             <span class="n">split_config</span><span class="o">=</span><span class="n">example_gen_pb2</span><span class="o">.</span><span class="n">SplitConfig</span><span class="p">(</span><span class="n">splits</span><span class="o">=</span><span class="p">[</span>
                 <span class="n">example_gen_pb2</span><span class="o">.</span><span class="n">SplitConfig</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'train'</span><span class="p">,</span> <span class="n">hash_buckets</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
                 <span class="n">example_gen_pb2</span><span class="o">.</span><span class="n">SplitConfig</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'eval'</span><span class="p">,</span> <span class="n">hash_buckets</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
             <span class="p">]))</span>
<span class="n">example_gen</span> <span class="o">=</span> <span class="n">ImportExampleGen</span><span class="p">(</span><span class="n">input_base</span><span class="o">=</span><span class="n">path_to_tfrecord_dir</span><span class="p">,</span> <span class="n">output_config</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_gen</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:absl:Running driver for ImportExampleGen
INFO:absl:MetadataStore with DB connection initialized
INFO:absl:select span and version = (0, None)
INFO:absl:latest span and version = (0, None)
INFO:absl:Running executor for ImportExampleGen
INFO:absl:Generating examples.
WARNING:apache_beam.runners.interactive.interactive_environment:Dependencies required for Interactive Beam PCollection visualization are not available, please use: `pip install apache-beam[interactive]` to install necessary dependencies to enable all data visualization features.
</pre>
</div>
</div>

<div class="output_area">




<div id="df149032-5542-40b0-8d26-f5774b501ff6"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#df149032-5542-40b0-8d26-f5774b501ff6');

        if (typeof window.interactive_beam_jquery == 'undefined') {
          var jqueryScript = document.createElement('script');
          jqueryScript.src = 'https://code.jquery.com/jquery-3.4.1.slim.min.js';
          jqueryScript.type = 'text/javascript';
          jqueryScript.onload = function() {
            var datatableScript = document.createElement('script');
            datatableScript.src = 'https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js';
            datatableScript.type = 'text/javascript';
            datatableScript.onload = function() {
              window.interactive_beam_jquery = jQuery.noConflict(true);
              window.interactive_beam_jquery(document).ready(function($){
                
              });
            }
            document.head.appendChild(datatableScript);
          };
          document.head.appendChild(jqueryScript);
        } else {
          window.interactive_beam_jquery(document).ready(function($){
            
          });
        }
</script>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:absl:Reading input TFRecord data /tmp/.keras/train/*.
WARNING:apache_beam.io.tfrecordio:Couldn't find python-snappy so the implementation of _TFRecordUtil._masked_crc32c is not as fast as it could be.
INFO:absl:Examples generated.
INFO:absl:Running publisher for ImportExampleGen
INFO:absl:MetadataStore with DB connection initialized
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<style>
.tfx-object.expanded {
  padding: 4px 8px 4px 8px;
  background: white;
  border: 1px solid #bbbbbb;
  box-shadow: 4px 4px 2px rgba(0,0,0,0.05);
}
.tfx-object, .tfx-object * {
  font-size: 11pt;
}
.tfx-object > .title {
  cursor: pointer;
}
.tfx-object .expansion-marker {
  color: #999999;
}
.tfx-object.expanded > .title > .expansion-marker:before {
  content: '▼';
}
.tfx-object.collapsed > .title > .expansion-marker:before {
  content: '▶';
}
.tfx-object .class-name {
  font-weight: bold;
}
.tfx-object .deemphasize {
  opacity: 0.5;
}
.tfx-object.collapsed > table.attr-table {
  display: none;
}
.tfx-object.expanded > table.attr-table {
  display: block;
}
.tfx-object table.attr-table {
  border: 2px solid white;
  margin-top: 5px;
}
.tfx-object table.attr-table td.attr-name {
  vertical-align: top;
  font-weight: bold;
}
.tfx-object table.attr-table td.attrvalue {
  text-align: left;
}
</style>
<script>
function toggleTfxObject(element) {
  var objElement = element.parentElement;
  if (objElement.classList.contains('collapsed')) {
    objElement.classList.remove('collapsed');
    objElement.classList.add('expanded');
  } else {
    objElement.classList.add('collapsed');
    objElement.classList.remove('expanded');
  }
}
</script>
<div class="tfx-object expanded">
<div class="title" onclick="toggleTfxObject(this)">
<span class="expansion-marker"></span><span class="class-name">ExecutionResult</span><span class="deemphasize"> at 0x10e255c70</span>
</div>
<table class="attr-table">
<tr>
<td class="attr-name">.execution_id</td>
<td class="attrvalue">1</td>
</tr>
<tr>
<td class="attr-name">.component</td>
<td class="attrvalue">
<style>
.tfx-object.expanded {
  padding: 4px 8px 4px 8px;
  background: white;
  border: 1px solid #bbbbbb;
  box-shadow: 4px 4px 2px rgba(0,0,0,0.05);
}
.tfx-object, .tfx-object * {
  font-size: 11pt;
}
.tfx-object > .title {
  cursor: pointer;
}
.tfx-object .expansion-marker {
  color: #999999;
}
.tfx-object.expanded > .title > .expansion-marker:before {
  content: '▼';
}
.tfx-object.collapsed > .title > .expansion-marker:before {
  content: '▶';
}
.tfx-object .class-name {
  font-weight: bold;
}
.tfx-object .deemphasize {
  opacity: 0.5;
}
.tfx-object.collapsed > table.attr-table {
  display: none;
}
.tfx-object.expanded > table.attr-table {
  display: block;
}
.tfx-object table.attr-table {
  border: 2px solid white;
  margin-top: 5px;
}
.tfx-object table.attr-table td.attr-name {
  vertical-align: top;
  font-weight: bold;
}
.tfx-object table.attr-table td.attrvalue {
  text-align: left;
}
</style>
<script>
function toggleTfxObject(element) {
  var objElement = element.parentElement;
  if (objElement.classList.contains('collapsed')) {
    objElement.classList.remove('collapsed');
    objElement.classList.add('expanded');
  } else {
    objElement.classList.add('collapsed');
    objElement.classList.remove('expanded');
  }
}
</script>
<div class="tfx-object collapsed">
<div class="title" onclick="toggleTfxObject(this)">
<span class="expansion-marker"></span><span class="class-name">ImportExampleGen</span><span class="deemphasize"> at 0x1866de640</span>
</div>
<table class="attr-table">
<tr>
<td class="attr-name">.inputs</td>
<td class="attrvalue">{}</td>
</tr>
<tr>
<td class="attr-name">.outputs</td>
<td class="attrvalue"><table class="attr-table"><tr>
<td class="attr-name">['examples']</td>
<td class="attrvalue">
<style>
.tfx-object.expanded {
  padding: 4px 8px 4px 8px;
  background: white;
  border: 1px solid #bbbbbb;
  box-shadow: 4px 4px 2px rgba(0,0,0,0.05);
}
.tfx-object, .tfx-object * {
  font-size: 11pt;
}
.tfx-object > .title {
  cursor: pointer;
}
.tfx-object .expansion-marker {
  color: #999999;
}
.tfx-object.expanded > .title > .expansion-marker:before {
  content: '▼';
}
.tfx-object.collapsed > .title > .expansion-marker:before {
  content: '▶';
}
.tfx-object .class-name {
  font-weight: bold;
}
.tfx-object .deemphasize {
  opacity: 0.5;
}
.tfx-object.collapsed > table.attr-table {
  display: none;
}
.tfx-object.expanded > table.attr-table {
  display: block;
}
.tfx-object table.attr-table {
  border: 2px solid white;
  margin-top: 5px;
}
.tfx-object table.attr-table td.attr-name {
  vertical-align: top;
  font-weight: bold;
}
.tfx-object table.attr-table td.attrvalue {
  text-align: left;
}
</style>
<script>
function toggleTfxObject(element) {
  var objElement = element.parentElement;
  if (objElement.classList.contains('collapsed')) {
    objElement.classList.remove('collapsed');
    objElement.classList.add('expanded');
  } else {
    objElement.classList.add('collapsed');
    objElement.classList.remove('expanded');
  }
}
</script>
<div class="tfx-object collapsed">
<div class="title" onclick="toggleTfxObject(this)">
<span class="expansion-marker"></span><span class="class-name">Channel</span> of type <span class="class-name">'Examples'</span> (1 artifact)<span class="deemphasize"> at 0x1866de7c0</span>
</div>
<table class="attr-table">
<tr>
<td class="attr-name">.type_name</td>
<td class="attrvalue">Examples</td>
</tr>
<tr>
<td class="attr-name">._artifacts</td>
<td class="attrvalue"><table class="attr-table"><tr>
<td class="attr-name">[0]</td>
<td class="attrvalue">
<style>
.tfx-object.expanded {
  padding: 4px 8px 4px 8px;
  background: white;
  border: 1px solid #bbbbbb;
  box-shadow: 4px 4px 2px rgba(0,0,0,0.05);
}
.tfx-object, .tfx-object * {
  font-size: 11pt;
}
.tfx-object > .title {
  cursor: pointer;
}
.tfx-object .expansion-marker {
  color: #999999;
}
.tfx-object.expanded > .title > .expansion-marker:before {
  content: '▼';
}
.tfx-object.collapsed > .title > .expansion-marker:before {
  content: '▶';
}
.tfx-object .class-name {
  font-weight: bold;
}
.tfx-object .deemphasize {
  opacity: 0.5;
}
.tfx-object.collapsed > table.attr-table {
  display: none;
}
.tfx-object.expanded > table.attr-table {
  display: block;
}
.tfx-object table.attr-table {
  border: 2px solid white;
  margin-top: 5px;
}
.tfx-object table.attr-table td.attr-name {
  vertical-align: top;
  font-weight: bold;
}
.tfx-object table.attr-table td.attrvalue {
  text-align: left;
}
</style>
<script>
function toggleTfxObject(element) {
  var objElement = element.parentElement;
  if (objElement.classList.contains('collapsed')) {
    objElement.classList.remove('collapsed');
    objElement.classList.add('expanded');
  } else {
    objElement.classList.add('collapsed');
    objElement.classList.remove('expanded');
  }
}
</script>
<div class="tfx-object collapsed">
<div class="title" onclick="toggleTfxObject(this)">
<span class="expansion-marker"></span><span class="class-name">Artifact</span> of type <span class="class-name">'Examples'</span> (uri: /var/folders/sr/1jd3j8k5791g_37qk2vdcc_80069vh/T/tfx-interactive-2021-04-03T16_45_34.079859-3hgwznh2/ImportExampleGen/examples/1)<span class="deemphasize"> at 0x1866f0220</span>
</div>
<table class="attr-table">
<tr>
<td class="attr-name">.type</td>
<td class="attrvalue">&lt;class 'tfx.types.standard_artifacts.Examples'&gt;</td>
</tr>
<tr>
<td class="attr-name">.uri</td>
<td class="attrvalue">/var/folders/sr/1jd3j8k5791g_37qk2vdcc_80069vh/T/tfx-interactive-2021-04-03T16_45_34.079859-3hgwznh2/ImportExampleGen/examples/1</td>
</tr>
<tr>
<td class="attr-name">.span</td>
<td class="attrvalue">0</td>
</tr>
<tr>
<td class="attr-name">.split_names</td>
<td class="attrvalue">["train", "eval"]</td>
</tr>
<tr>
<td class="attr-name">.version</td>
<td class="attrvalue">0</td>
</tr>
</table>
</div>
</td>
</tr></table></td>
</tr>
</table>
</div>
</td>
</tr></table></td>
</tr>
<tr>
<td class="attr-name">.exec_properties</td>
<td class="attrvalue"><table class="attr-table">
<tr>
<td class="attr-name">['input_base']</td>
<td class="attrvalue">/tmp/.keras/train</td>
</tr>
<tr>
<td class="attr-name">['input_config']</td>
<td class="attrvalue">{
  "splits": [
    {
      "name": "single_split",
      "pattern": "*"
    }
  ]
}</td>
</tr>
<tr>
<td class="attr-name">['output_config']</td>
<td class="attrvalue">{
  "split_config": {
    "splits": [
      {
        "hash_buckets": 3,
        "name": "train"
      },
      {
        "hash_buckets": 1,
        "name": "eval"
      }
    ]
  }
}</td>
</tr>
<tr>
<td class="attr-name">['output_data_format']</td>
<td class="attrvalue">6</td>
</tr>
<tr>
<td class="attr-name">['custom_config']</td>
<td class="attrvalue">None</td>
</tr>
<tr>
<td class="attr-name">['range_config']</td>
<td class="attrvalue">None</td>
</tr>
<tr>
<td class="attr-name">['span']</td>
<td class="attrvalue">0</td>
</tr>
<tr>
<td class="attr-name">['version']</td>
<td class="attrvalue">None</td>
</tr>
<tr>
<td class="attr-name">['input_fingerprint']</td>
<td class="attrvalue">split:single_split,num_files:5,total_bytes:9813103,xor_checksum:1617461143,sum_checksum:7984741591</td>
</tr>
</table></td>
</tr>
</table>
</div>
</td>
</tr>
<tr>
<td class="attr-name">.component.inputs</td>
<td class="attrvalue">{}</td>
</tr>
<tr>
<td class="attr-name">.component.outputs</td>
<td class="attrvalue"><table class="attr-table"><tr>
<td class="attr-name">['examples']</td>
<td class="attrvalue">
<style>
.tfx-object.expanded {
  padding: 4px 8px 4px 8px;
  background: white;
  border: 1px solid #bbbbbb;
  box-shadow: 4px 4px 2px rgba(0,0,0,0.05);
}
.tfx-object, .tfx-object * {
  font-size: 11pt;
}
.tfx-object > .title {
  cursor: pointer;
}
.tfx-object .expansion-marker {
  color: #999999;
}
.tfx-object.expanded > .title > .expansion-marker:before {
  content: '▼';
}
.tfx-object.collapsed > .title > .expansion-marker:before {
  content: '▶';
}
.tfx-object .class-name {
  font-weight: bold;
}
.tfx-object .deemphasize {
  opacity: 0.5;
}
.tfx-object.collapsed > table.attr-table {
  display: none;
}
.tfx-object.expanded > table.attr-table {
  display: block;
}
.tfx-object table.attr-table {
  border: 2px solid white;
  margin-top: 5px;
}
.tfx-object table.attr-table td.attr-name {
  vertical-align: top;
  font-weight: bold;
}
.tfx-object table.attr-table td.attrvalue {
  text-align: left;
}
</style>
<script>
function toggleTfxObject(element) {
  var objElement = element.parentElement;
  if (objElement.classList.contains('collapsed')) {
    objElement.classList.remove('collapsed');
    objElement.classList.add('expanded');
  } else {
    objElement.classList.add('collapsed');
    objElement.classList.remove('expanded');
  }
}
</script>
<div class="tfx-object collapsed">
<div class="title" onclick="toggleTfxObject(this)">
<span class="expansion-marker"></span><span class="class-name">Channel</span> of type <span class="class-name">'Examples'</span> (1 artifact)<span class="deemphasize"> at 0x1866de7c0</span>
</div>
<table class="attr-table">
<tr>
<td class="attr-name">.type_name</td>
<td class="attrvalue">Examples</td>
</tr>
<tr>
<td class="attr-name">._artifacts</td>
<td class="attrvalue"><table class="attr-table"><tr>
<td class="attr-name">[0]</td>
<td class="attrvalue">
<style>
.tfx-object.expanded {
  padding: 4px 8px 4px 8px;
  background: white;
  border: 1px solid #bbbbbb;
  box-shadow: 4px 4px 2px rgba(0,0,0,0.05);
}
.tfx-object, .tfx-object * {
  font-size: 11pt;
}
.tfx-object > .title {
  cursor: pointer;
}
.tfx-object .expansion-marker {
  color: #999999;
}
.tfx-object.expanded > .title > .expansion-marker:before {
  content: '▼';
}
.tfx-object.collapsed > .title > .expansion-marker:before {
  content: '▶';
}
.tfx-object .class-name {
  font-weight: bold;
}
.tfx-object .deemphasize {
  opacity: 0.5;
}
.tfx-object.collapsed > table.attr-table {
  display: none;
}
.tfx-object.expanded > table.attr-table {
  display: block;
}
.tfx-object table.attr-table {
  border: 2px solid white;
  margin-top: 5px;
}
.tfx-object table.attr-table td.attr-name {
  vertical-align: top;
  font-weight: bold;
}
.tfx-object table.attr-table td.attrvalue {
  text-align: left;
}
</style>
<script>
function toggleTfxObject(element) {
  var objElement = element.parentElement;
  if (objElement.classList.contains('collapsed')) {
    objElement.classList.remove('collapsed');
    objElement.classList.add('expanded');
  } else {
    objElement.classList.add('collapsed');
    objElement.classList.remove('expanded');
  }
}
</script>
<div class="tfx-object collapsed">
<div class="title" onclick="toggleTfxObject(this)">
<span class="expansion-marker"></span><span class="class-name">Artifact</span> of type <span class="class-name">'Examples'</span> (uri: /var/folders/sr/1jd3j8k5791g_37qk2vdcc_80069vh/T/tfx-interactive-2021-04-03T16_45_34.079859-3hgwznh2/ImportExampleGen/examples/1)<span class="deemphasize"> at 0x1866f0220</span>
</div>
<table class="attr-table">
<tr>
<td class="attr-name">.type</td>
<td class="attrvalue">&lt;class 'tfx.types.standard_artifacts.Examples'&gt;</td>
</tr>
<tr>
<td class="attr-name">.uri</td>
<td class="attrvalue">/var/folders/sr/1jd3j8k5791g_37qk2vdcc_80069vh/T/tfx-interactive-2021-04-03T16_45_34.079859-3hgwznh2/ImportExampleGen/examples/1</td>
</tr>
<tr>
<td class="attr-name">.span</td>
<td class="attrvalue">0</td>
</tr>
<tr>
<td class="attr-name">.split_names</td>
<td class="attrvalue">["train", "eval"]</td>
</tr>
<tr>
<td class="attr-name">.version</td>
<td class="attrvalue">0</td>
</tr>
</table>
</div>
</td>
</tr></table></td>
</tr>
</table>
</div>
</td>
</tr></table></td>
</tr>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Artifacts de salida de <code>ExampleGen</code>. Este componente genera <strong>dos artifacts</strong>, el artifact de entrenamiento y el de evaluación:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">artifact</span> <span class="o">=</span> <span class="n">example_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'examples'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">artifact</span><span class="o">.</span><span class="n">split_names</span><span class="p">,</span> <span class="n">artifact</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Vemos las tres primeras muestras:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Get the URI of the output artifact representing the training examples, which is a directory</span>
<span class="n">train_uri</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">example_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'examples'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="s1">'train'</span><span class="p">)</span>

<span class="c1"># Get the list of files in this directory (all compressed TFRecord files)</span>
<span class="n">tfrecord_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_uri</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_uri</span><span class="p">)]</span>

<span class="c1"># Create a `TFRecordDataset` to read these files</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">tfrecord_filenames</span><span class="p">,</span> <span class="n">compression_type</span><span class="o">=</span><span class="s2">"GZIP"</span><span class="p">)</span>

<span class="c1"># Iterate over the first 3 records and decode them.</span>
<span class="k">for</span> <span class="n">tfrecord</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
  <span class="n">serialized_example</span> <span class="o">=</span> <span class="n">tfrecord</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
  <span class="n">example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span><span class="p">()</span>
  <span class="n">example</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">serialized_example</span><span class="p">)</span>
  <span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Una vez que <code>ExampleGen</code> ha terminado la ingestión, pasamos al análisis de los datos.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="StatisticsGen">
<a class="anchor" href="#StatisticsGen" aria-hidden="true"><span class="octicon octicon-link"></span></a>StatisticsGen<a class="anchor-link" href="#StatisticsGen"> </a>
</h3>
<p>El componente <code>StatisticsGen</code> calcula estadísticas de tu dataset para su análisis, y para uso de componentes posteriores en el pipeline. Hace uso de la librería <a href="https://www.tensorflow.org/tfx/data_validation/get_started">TensorFlow Data Validation</a>.</p>
<p><code>StatisticsGen</code> tiene como entrada los datos ingestados de <code>ExampleGen</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">statistics_gen</span> <span class="o">=</span> <span class="n">StatisticsGen</span><span class="p">(</span>
    <span class="n">examples</span><span class="o">=</span><span class="n">example_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'examples'</span><span class="p">])</span>
<span class="n">context</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">statistics_gen</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">statistics_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'statistics'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Artifacts de salida de <code>StatisticsGen</code>. Se pueden generar diferentes gráficas distintas a la mostrada.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="SchemaGen">
<a class="anchor" href="#SchemaGen" aria-hidden="true"><span class="octicon octicon-link"></span></a>SchemaGen<a class="anchor-link" href="#SchemaGen"> </a>
</h3>
<p>El componente <code>SchemaGen</code> genera un esquema de tus datos. Un esquema define los tipos de datos, márgenes y propiedades de las features de tu dataset. Usa la librería de <a href="https://www.tensorflow.org/tfx/data_validation/get_started">TensorFlow Data Validation</a>.</p>
<p>El esquema generado es best-effort, ya que simplemente hace lo que puede para averiguar ciertas propiedades de los datos. Se espera que el usuario revise y modifique según aplique.</p>
<p>Note: The generated schema is best-effort and only tries to infer basic properties of the data. It is expected that you review and modify it as needed.</p>
<p><code>SchemaGen</code> usa como entrada las estadísticas generadas con <code>StatisticsGen</code>, mirando al split de datos usado por defecto.</p>
<p>IMPORTANTE: the desired behavior of infer_schema(..., infer_feature_shape=True) would be to infer feature shapes for FixedLenFeatures while parsing VarLenFeatures to SparseFeatures in the schema</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">schema_gen</span> <span class="o">=</span> <span class="n">SchemaGen</span><span class="p">(</span>
    <span class="n">statistics</span><span class="o">=</span><span class="n">statistics_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'statistics'</span><span class="p">],</span>
    <span class="n">infer_feature_shape</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">schema_gen</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Artifact de salida de <code>SchemaGen</code>, que es el esquema mostrado como tabla:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">schema_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'schema'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Each feature in your dataset shows up as a row in the schema table, alongside its properties. The schema also captures all the values that a categorical feature takes on, denoted as its domain.</p>
<p>To learn more about schemas, see <a href="https://www.tensorflow.org/tfx/guide/schemagen">the SchemaGen documentation</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="ExampleValidator">
<a class="anchor" href="#ExampleValidator" aria-hidden="true"><span class="octicon octicon-link"></span></a>ExampleValidator<a class="anchor-link" href="#ExampleValidator"> </a>
</h3>
<p>El componente <code>ExampleValidator</code> detecta anomalías en los datos, según el esquema generado anteriormente. Hace uso de la librería  <a href="https://www.tensorflow.org/tfx/data_validation/get_started">TensorFlow Data Validation</a> .</p>
<p><code>ExampleValidator</code> usa como entrada la salida de <code>StatisticsGen</code>, y la salida de <code>SchemaGen</code> (esquema)</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">example_validator</span> <span class="o">=</span> <span class="n">ExampleValidator</span><span class="p">(</span>
    <span class="n">statistics</span><span class="o">=</span><span class="n">statistics_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'statistics'</span><span class="p">],</span>
    <span class="n">schema</span><span class="o">=</span><span class="n">schema_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'schema'</span><span class="p">])</span>
<span class="n">context</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_validator</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Artifact de salida de <code>ExampleValidator</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">example_validator</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'anomalies'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In the anomalies table, we can see that there are no anomalies. This is what we'd expect, since this the first dataset that we've analyzed and the schema is tailored to it. You should review this schema -- anything unexpected means an anomaly in the data. Once reviewed, the schema can be used to guard future data, and anomalies produced here can be used to debug model performance, understand how your data evolves over time, and identify data errors.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Transform">
<a class="anchor" href="#Transform" aria-hidden="true"><span class="octicon octicon-link"></span></a>Transform<a class="anchor-link" href="#Transform"> </a>
</h3>
<p>El componente <code>Transform</code> realiza <strong>Feature engineering</strong> tanto en entrenamiento como en serving. Hace uso de la librería <a href="https://www.tensorflow.org/tfx/transform/get_started">TensorFlow Transform</a>.</p>
<p><code>Transform</code> toma como entrada los datos de <code>ExampleGen</code>, el esquema de <code>SchemaGen</code> (ojo al parámetro <code>infer_feature_shape</code>), así como el código python que realiza la transformación.</p>
<p>Let's see an example of user-defined Transform code below (for an introduction to the TensorFlow Transform APIs, <a href="https://www.tensorflow.org/tfx/tutorials/transform/simple">see the tutorial</a>). First, we define a few constants for feature engineering:</p>
<p>Nota: La celda <code>%%writefile</code> graba el contenido <code>.py</code> en un archivo, que luego se carga al llamar al componente <code>Transform</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_stackoverflow_constants_module_file</span> <span class="o">=</span> <span class="s1">'stackoverflow_constants.py'</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> {_stackoverflow_constants_module_file}

<span class="n">_FEATURE_KEY</span> <span class="o">=</span> <span class="s1">'text'</span>
<span class="n">_LABEL_KEY</span> <span class="o">=</span> <span class="s1">'label'</span>

<span class="n">_DROPOUT_RATE</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">_EMBEDDING_UNITS</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">_EVAL_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">_HIDDEN_UNITS</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">_LEARNING_RATE</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">_L2_REGULARIZER</span><span class="o">=</span><span class="mf">0.01</span>
<span class="n">_LSTM_UNITS</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">_VOCAB_SIZE</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">_MAX_LEN</span> <span class="o">=</span> <span class="mi">400</span>
<span class="n">_TRAIN_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">_NUM_CLASSES</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">_NUM_FILTERS</span><span class="o">=</span><span class="mi">200</span>
<span class="n">_FILTER_SIZE</span><span class="o">=</span><span class="mi">4</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Escribimos la función <code>preprocessing_fn</code> que es la que llamará el componente <code>Transform</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_stackoverflow_transform_module_file</span> <span class="o">=</span> <span class="s1">'stackoverflow_transform.py'</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> {_stackoverflow_transform_module_file}

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Text</span>

<span class="kn">import</span> <span class="nn">stackoverflow_constants</span>

<span class="kn">import</span> <span class="nn">absl</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">import</span> <span class="nn">tensorflow_transform</span> <span class="k">as</span> <span class="nn">tft</span>

<span class="kn">from</span> <span class="nn">tfx.components.trainer.fn_args_utils</span> <span class="kn">import</span> <span class="n">FnArgs</span>

<span class="n">_FEATURE_KEY</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_FEATURE_KEY</span>
<span class="n">_LABEL_KEY</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_LABEL_KEY</span>

<span class="n">_DROPOUT_RATE</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_DROPOUT_RATE</span>
<span class="n">_EMBEDDING_UNITS</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_EMBEDDING_UNITS</span>
<span class="n">_EVAL_BATCH_SIZE</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_EVAL_BATCH_SIZE</span>
<span class="n">_HIDDEN_UNITS</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_HIDDEN_UNITS</span>
<span class="n">_LEARNING_RATE</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_LEARNING_RATE</span>
<span class="n">_L2_REGULARIZER</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_L2_REGULARIZER</span>
<span class="n">_LSTM_UNITS</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_LSTM_UNITS</span>
<span class="n">_VOCAB_SIZE</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_VOCAB_SIZE</span>
<span class="n">_MAX_LEN</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_MAX_LEN</span>
<span class="n">_TRAIN_BATCH_SIZE</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_TRAIN_BATCH_SIZE</span>
<span class="n">_NUM_CLASSES</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_NUM_CLASSES</span>
<span class="n">_NUM_FILTERS</span><span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_NUM_FILTERS</span>
<span class="n">_FILTER_SIZE</span><span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_FILTER_SIZE</span>

<span class="k">def</span> <span class="nf">_transformed_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">is_input</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">key</span> <span class="o">+</span> <span class="p">(</span><span class="s1">'_xf_input'</span> <span class="k">if</span> <span class="n">is_input</span> <span class="k">else</span> <span class="s1">'_xf'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_tokenize_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
  <span class="n">text_sparse</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">to_sparse</span><span class="p">()</span>
  <span class="c1"># tft.apply_vocabulary doesn't reserve 0 for oov words. In order to comply</span>
  <span class="c1"># with convention and use mask_zero in keras.embedding layer, set oov value</span>
  <span class="c1"># to _VOCAB_SIZE and padding value to -1. Then add 1 to all the tokens.</span>
  <span class="n">text_indices</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">compute_and_apply_vocabulary</span><span class="p">(</span>
      <span class="n">text_sparse</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="n">_VOCAB_SIZE</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">_VOCAB_SIZE</span><span class="p">)</span>
  <span class="n">dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(</span><span class="n">text_indices</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
  <span class="c1"># TFX transform expects the transform result to be FixedLenFeature.</span>
  <span class="n">padding_config</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">_MAX_LEN</span><span class="p">]]</span>
  <span class="n">dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">dense</span><span class="p">,</span> <span class="n">padding_config</span><span class="p">,</span> <span class="s1">'CONSTANT'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">padded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">dense</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">_MAX_LEN</span><span class="p">])</span>
  <span class="n">padded</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">return</span> <span class="n">padded</span>


<span class="c1"># TFX Transform will call this function.</span>
<span class="k">def</span> <span class="nf">preprocessing_fn</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
  <span class="sd">"""tf.transform's callback function for preprocessing inputs.</span>
<span class="sd">  Args:</span>
<span class="sd">    inputs: map from feature keys to raw not-yet-transformed features.</span>
<span class="sd">  Returns:</span>
<span class="sd">    Map from string feature key to transformed feature operations.</span>
<span class="sd">  """</span>
  <span class="k">return</span> <span class="p">{</span>
      <span class="n">_transformed_name</span><span class="p">(</span><span class="n">_LABEL_KEY</span><span class="p">):</span>
          <span class="n">inputs</span><span class="p">[</span><span class="n">_LABEL_KEY</span><span class="p">],</span>
      <span class="n">_transformed_name</span><span class="p">(</span><span class="n">_FEATURE_KEY</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
          <span class="n">_tokenize_text</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">_FEATURE_KEY</span><span class="p">])</span>
  <span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ejecutamos el componente <code>Transform</code> que transforma los datos.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">transform</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">(</span>
    <span class="n">examples</span><span class="o">=</span><span class="n">example_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'examples'</span><span class="p">],</span>
    <span class="n">schema</span><span class="o">=</span><span class="n">schema_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'schema'</span><span class="p">],</span>
    <span class="n">module_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">_stackoverflow_transform_module_file</span><span class="p">))</span>

<span class="n">context</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Artifacts de salida de <code>Transform</code>. Genera dos artifacts:</p>
<ul>
<li>
<code>transform_graph</code> is the graph that can perform the preprocessing operations (this graph will be included in the serving and evaluation models).</li>
<li>
<code>transformed_examples</code> represents the preprocessed training and evaluation data.</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">transform</span><span class="o">.</span><span class="n">outputs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Vemos el artifact <code>transform_graph</code>, que apunta a un directorio que contiene 3 subdirectorios.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_uri</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'transform_graph'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uri</span>
<span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_uri</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ol>
<li>El subdirectorio <code>transformed_metadata</code> contiene el esquema de los datos preprocesados. </li>
<li>El subdirectorio <code>transform_fn</code> contiene el grfo de procesado. </li>
<li>El subdirectorio <code>metadata</code> contiene el esquema de los datos originales.</li>
</ol>
<p>Vamos las tres primeras transformaciones.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered celltag_outputPrepend">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Get the URI of the output artifact representing the transformed examples, which is a directory</span>
<span class="n">train_uri</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'transformed_examples'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="s1">'train'</span><span class="p">)</span>

<span class="c1"># Get the list of files in this directory (all compressed TFRecord files)</span>
<span class="n">tfrecord_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_uri</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_uri</span><span class="p">)]</span>

<span class="c1"># Create a `TFRecordDataset` to read these files</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">tfrecord_filenames</span><span class="p">,</span> <span class="n">compression_type</span><span class="o">=</span><span class="s2">"GZIP"</span><span class="p">)</span>

<span class="c1"># Iterate over the first 3 records and decode them.</span>
<span class="k">for</span> <span class="n">tfrecord</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
  <span class="n">serialized_example</span> <span class="o">=</span> <span class="n">tfrecord</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
  <span class="n">example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span><span class="p">()</span>
  <span class="n">example</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">serialized_example</span><span class="p">)</span>
  <span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Después de tokenizar con el componente <code>Transform</code>, el siguiente paso es el entrenamiento del modelo.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Trainer">
<a class="anchor" href="#Trainer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Trainer<a class="anchor-link" href="#Trainer"> </a>
</h3>
<p>El componente <code>Trainer</code> entrena un modelo definido en TensorFlow. Default Trainer support Estimator API, to use Keras API, you need to specify <a href="https://github.com/tensorflow/community/blob/master/rfcs/20200117-tfx-generic-trainer.md">Generic Trainer</a> by setup <code>custom_executor_spec=executor_spec.ExecutorClassSpec(GenericExecutor)</code> in Trainer's contructor.</p>
<p><code>Trainer</code> toma como entrada el esquema de <code>SchemaGen</code>, los datos transformados y el grafo de <code>Transform</code>, parámetros de entrenamiento, y el código python para entrenar.</p>
<p>Let's see an example of user-defined model code below (for an introduction to the TensorFlow Keras APIs, <a href="https://www.tensorflow.org/guide/keras">see the tutorial</a>):</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_stackoverflow_trainer_module_file</span> <span class="o">=</span> <span class="s1">'stackoverflow_trainer.py'</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%writefile</span> {_stackoverflow_trainer_module_file}

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Text</span>

<span class="kn">import</span> <span class="nn">absl</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">import</span> <span class="nn">tensorflow_transform</span> <span class="k">as</span> <span class="nn">tft</span>

<span class="kn">from</span> <span class="nn">tfx.components.trainer.fn_args_utils</span> <span class="kn">import</span> <span class="n">FnArgs</span>

<span class="kn">import</span> <span class="nn">stackoverflow_constants</span>

<span class="n">_FEATURE_KEY</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_FEATURE_KEY</span>
<span class="n">_LABEL_KEY</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_LABEL_KEY</span>

<span class="n">_DROPOUT_RATE</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_DROPOUT_RATE</span>
<span class="n">_EMBEDDING_UNITS</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_EMBEDDING_UNITS</span>
<span class="n">_EVAL_BATCH_SIZE</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_EVAL_BATCH_SIZE</span>
<span class="n">_HIDDEN_UNITS</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_HIDDEN_UNITS</span>
<span class="n">_LEARNING_RATE</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_LEARNING_RATE</span>
<span class="n">_L2_REGULARIZER</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_L2_REGULARIZER</span>
<span class="n">_LSTM_UNITS</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_LSTM_UNITS</span>
<span class="n">_VOCAB_SIZE</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_VOCAB_SIZE</span>
<span class="n">_MAX_LEN</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_MAX_LEN</span>
<span class="n">_TRAIN_BATCH_SIZE</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_TRAIN_BATCH_SIZE</span>
<span class="n">_NUM_CLASSES</span> <span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_NUM_CLASSES</span>
<span class="n">_NUM_FILTERS</span><span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_NUM_FILTERS</span>
<span class="n">_FILTER_SIZE</span><span class="o">=</span> <span class="n">stackoverflow_constants</span><span class="o">.</span><span class="n">_FILTER_SIZE</span>

<span class="k">def</span> <span class="nf">_transformed_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">is_input</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">key</span> <span class="o">+</span> <span class="p">(</span><span class="s1">'_xf_input'</span> <span class="k">if</span> <span class="n">is_input</span> <span class="k">else</span> <span class="s1">'_xf'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_gzip_reader_fn</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">compression_type</span><span class="o">=</span><span class="s1">'GZIP'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_input_fn</span><span class="p">(</span><span class="n">file_pattern</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Text</span><span class="p">],</span>
              <span class="n">tf_transform_output</span><span class="p">:</span> <span class="n">tft</span><span class="o">.</span><span class="n">TFTransformOutput</span><span class="p">,</span>
              <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>

  <span class="n">transformed_feature_spec</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">tf_transform_output</span><span class="o">.</span><span class="n">transformed_feature_spec</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

  <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">make_batched_features_dataset</span><span class="p">(</span>
      <span class="n">file_pattern</span><span class="o">=</span><span class="n">file_pattern</span><span class="p">,</span>
      <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
      <span class="n">features</span><span class="o">=</span><span class="n">transformed_feature_spec</span><span class="p">,</span>
      <span class="n">reader</span><span class="o">=</span><span class="n">_gzip_reader_fn</span><span class="p">,</span>
      <span class="n">label_key</span><span class="o">=</span><span class="n">_transformed_name</span><span class="p">(</span><span class="n">_LABEL_KEY</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">dataset</span>


<span class="k">def</span> <span class="nf">_build_keras_model</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>

  <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
      <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">_VOCAB_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span><span class="n">_EMBEDDING_UNITS</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">_transformed_name</span><span class="p">(</span><span class="n">_FEATURE_KEY</span><span class="p">)),</span>
      <span class="c1">#keras.layers.Bidirectional(keras.layers.LSTM(_LSTM_UNITS, dropout=_DROPOUT_RATE)),</span>
      <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">((</span><span class="n">_MAX_LEN</span><span class="p">,</span> <span class="n">_EMBEDDING_UNITS</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
      <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">_NUM_FILTERS</span><span class="p">,(</span><span class="n">_FILTER_SIZE</span><span class="p">,</span><span class="n">_EMBEDDING_UNITS</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">'relu'</span><span class="p">,</span><span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="n">_L2_REGULARIZER</span><span class="p">)),</span>
      <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
      <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">_DROPOUT_RATE</span><span class="p">),</span>
      <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">_HIDDEN_UNITS</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">'relu'</span><span class="p">),</span>
      <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">_NUM_CLASSES</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span><span class="s1">'softmax'</span><span class="p">)</span>
  <span class="p">])</span>

  <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
      <span class="n">loss</span><span class="o">=</span><span class="s1">'sparse_categorical_crossentropy'</span><span class="p">,</span>
      <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">_LEARNING_RATE</span><span class="p">),</span>
      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">'sparse_categorical_accuracy'</span><span class="p">])</span>



  <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">print_fn</span><span class="o">=</span><span class="n">absl</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">model</span>


<span class="k">def</span> <span class="nf">_get_serve_tf_examples_fn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tf_transform_output</span><span class="p">):</span>

  <span class="n">model</span><span class="o">.</span><span class="n">tft_layer</span> <span class="o">=</span> <span class="n">tf_transform_output</span><span class="o">.</span><span class="n">transform_features_layer</span><span class="p">()</span>

  <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
  <span class="k">def</span> <span class="nf">serve_tf_examples_fn</span><span class="p">(</span><span class="n">serialized_tf_examples</span><span class="p">):</span>
    <span class="sd">"""Returns the output to be used in the serving signature."""</span>
    <span class="n">feature_spec</span> <span class="o">=</span> <span class="n">tf_transform_output</span><span class="o">.</span><span class="n">raw_feature_spec</span><span class="p">()</span>
    <span class="n">feature_spec</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">_LABEL_KEY</span><span class="p">)</span>
    <span class="n">parsed_features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_example</span><span class="p">(</span><span class="n">serialized_tf_examples</span><span class="p">,</span> <span class="n">feature_spec</span><span class="p">)</span>
    <span class="n">transformed_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tft_layer</span><span class="p">(</span><span class="n">parsed_features</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">(</span><span class="n">transformed_features</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">serve_tf_examples_fn</span>


<span class="c1"># TFX Trainer will call this function.</span>
<span class="k">def</span> <span class="nf">run_fn</span><span class="p">(</span><span class="n">fn_args</span><span class="p">:</span> <span class="n">FnArgs</span><span class="p">):</span>

  <span class="n">tf_transform_output</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">TFTransformOutput</span><span class="p">(</span><span class="n">fn_args</span><span class="o">.</span><span class="n">transform_output</span><span class="p">)</span>

  <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">_input_fn</span><span class="p">(</span>
      <span class="n">fn_args</span><span class="o">.</span><span class="n">train_files</span><span class="p">,</span> <span class="n">tf_transform_output</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">_TRAIN_BATCH_SIZE</span><span class="p">)</span>

  <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">_input_fn</span><span class="p">(</span>
      <span class="n">fn_args</span><span class="o">.</span><span class="n">eval_files</span><span class="p">,</span> <span class="n">tf_transform_output</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">_EVAL_BATCH_SIZE</span><span class="p">)</span>

  <span class="n">mirrored_strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">MirroredStrategy</span><span class="p">()</span>
  <span class="k">with</span> <span class="n">mirrored_strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">_build_keras_model</span><span class="p">()</span>


  <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
      <span class="n">train_dataset</span><span class="p">,</span>
      <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">fn_args</span><span class="o">.</span><span class="n">train_steps</span><span class="p">,</span>
      <span class="n">validation_data</span><span class="o">=</span><span class="n">eval_dataset</span><span class="p">,</span>
      <span class="n">validation_steps</span><span class="o">=</span><span class="n">fn_args</span><span class="o">.</span><span class="n">eval_steps</span><span class="p">)</span>

  <span class="n">signatures</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">'serving_default'</span><span class="p">:</span>
          <span class="n">_get_serve_tf_examples_fn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>
                                    <span class="n">tf_transform_output</span><span class="p">)</span><span class="o">.</span><span class="n">get_concrete_function</span><span class="p">(</span>
                                        <span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span>
                                            <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span>
                                            <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s1">'examples'</span><span class="p">)),</span>
  <span class="p">}</span>

  <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fn_args</span><span class="o">.</span><span class="n">serving_model_dir</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s1">'tf'</span><span class="p">,</span> <span class="n">signatures</span><span class="o">=</span><span class="n">signatures</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Pasamos el código al componente <code>Trainer</code> para entrenar:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">module_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">_stackoverflow_trainer_module_file</span><span class="p">),</span>
    <span class="n">custom_executor_spec</span><span class="o">=</span><span class="n">executor_spec</span><span class="o">.</span><span class="n">ExecutorClassSpec</span><span class="p">(</span><span class="n">GenericExecutor</span><span class="p">),</span>
    <span class="n">examples</span><span class="o">=</span><span class="n">transform</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'transformed_examples'</span><span class="p">],</span>
    <span class="n">transform_graph</span><span class="o">=</span><span class="n">transform</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'transform_graph'</span><span class="p">],</span>
    <span class="n">schema</span><span class="o">=</span><span class="n">schema_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'schema'</span><span class="p">],</span>
    <span class="n">train_args</span><span class="o">=</span><span class="n">trainer_pb2</span><span class="o">.</span><span class="n">TrainArgs</span><span class="p">(</span><span class="n">num_steps</span><span class="o">=</span><span class="mi">3000</span><span class="p">),</span>
    <span class="n">eval_args</span><span class="o">=</span><span class="n">trainer_pb2</span><span class="o">.</span><span class="n">EvalArgs</span><span class="p">(</span><span class="n">num_steps</span><span class="o">=</span><span class="mi">3000</span><span class="p">))</span>
<span class="n">context</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">trainer</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Analyze-Training-with-TensorBoard">
<a class="anchor" href="#Analyze-Training-with-TensorBoard" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analyze Training with TensorBoard<a class="anchor-link" href="#Analyze-Training-with-TensorBoard"> </a>
</h4>
<p>Take a peek at the trainer artifact. It points to a directory containing the model subdirectories.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_artifact_dir</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'model'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uri</span>
<span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">model_artifact_dir</span><span class="p">))</span>
<span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_artifact_dir</span><span class="p">,</span> <span class="s1">'serving_model_dir'</span><span class="p">)</span>
<span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">model_dir</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Optionally, we can connect TensorBoard to the Trainer to analyze our model's training curves.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#model_run_artifact_dir = trainer.outputs['model_run'].get()[0].uri</span>

<span class="c1">#%load_ext tensorboard</span>
<span class="c1">#%tensorboard --logdir {model_run_artifact_dir}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Evaluator">
<a class="anchor" href="#Evaluator" aria-hidden="true"><span class="octicon octicon-link"></span></a>Evaluator<a class="anchor-link" href="#Evaluator"> </a>
</h3>
<p>El componente <code>Evaluator</code> evalúa métricas sobre el set de evaluación. hace uso de la librería <a href="https://www.tensorflow.org/tfx/model_analysis/get_started">TensorFlow Model Analysis</a>. <code>Evaluator</code> también valida si un modelo nuevo es mejor que el anterior, y en caso afirmativo, lo promociona. Esto es útil en el case de un pipeline de producción donde se entrenan y validan modelos diariamente. en este notebook sólo entrenamos un modelo, así que es el único que se promociona en cualqui caso.</p>
<p><code>Evaluator</code> tomo como entrada <code>ExampleGen</code>, el modelo de <code>Trainer</code>, and slicing configuration. The slicing configuration allows you to slice your metrics on feature values (e.g. how does your model perform on taxi trips that start at 8am versus 8pm?). See an example of this configuration below:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">example_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'examples'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">eval_config</span> <span class="o">=</span> <span class="n">tfma</span><span class="o">.</span><span class="n">EvalConfig</span><span class="p">(</span>
      <span class="n">model_specs</span><span class="o">=</span><span class="p">[</span><span class="n">tfma</span><span class="o">.</span><span class="n">ModelSpec</span><span class="p">(</span><span class="n">label_key</span><span class="o">=</span><span class="s1">'label'</span><span class="p">)],</span>
      <span class="n">slicing_specs</span><span class="o">=</span><span class="p">[</span><span class="n">tfma</span><span class="o">.</span><span class="n">SlicingSpec</span><span class="p">()],</span>
      <span class="n">metrics_specs</span><span class="o">=</span><span class="p">[</span>
          <span class="n">tfma</span><span class="o">.</span><span class="n">MetricsSpec</span><span class="p">(</span><span class="n">metrics</span><span class="o">=</span><span class="p">[</span>
              <span class="n">tfma</span><span class="o">.</span><span class="n">MetricConfig</span><span class="p">(</span>
                  <span class="n">class_name</span><span class="o">=</span><span class="s1">'SparseCategoricalAccuracy'</span><span class="p">,</span>
                  <span class="n">threshold</span><span class="o">=</span><span class="n">tfma</span><span class="o">.</span><span class="n">MetricThreshold</span><span class="p">(</span>
                      <span class="n">value_threshold</span><span class="o">=</span><span class="n">tfma</span><span class="o">.</span><span class="n">GenericValueThreshold</span><span class="p">(</span>
                          <span class="c1"># Si el modelo no tiene una precisión mayor de 0.8</span>
                          <span class="n">lower_bound</span><span class="o">=</span><span class="p">{</span><span class="s1">'value'</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">}),</span>
                      <span class="n">change_threshold</span><span class="o">=</span><span class="n">tfma</span><span class="o">.</span><span class="n">GenericChangeThreshold</span><span class="p">(</span>
                          <span class="n">direction</span><span class="o">=</span><span class="n">tfma</span><span class="o">.</span><span class="n">MetricDirection</span><span class="o">.</span><span class="n">HIGHER_IS_BETTER</span><span class="p">,</span>
                          <span class="n">absolute</span><span class="o">=</span><span class="p">{</span><span class="s1">'value'</span><span class="p">:</span> <span class="o">-</span><span class="mf">1e-2</span><span class="p">})))</span>
          <span class="p">])</span>
      <span class="p">]</span>
      <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Pasamos la configuración anterior al componente <code>Evaluator</code>:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">tfx.types</span> <span class="kn">import</span> <span class="n">standard_artifacts</span>
<span class="kn">from</span> <span class="nn">tfx.types</span> <span class="kn">import</span> <span class="n">channel</span>

<span class="c1"># Use TFMA to compute a evaluation statistics over features of a model and</span>
<span class="c1"># validate them against a baseline.</span>

<span class="c1"># The model resolver is only required if performing model validation in addition</span>
<span class="c1"># to evaluation. In this case we validate against the latest blessed model. If</span>
<span class="c1"># no model has been blessed before (as in this case) the evaluator will make our</span>
<span class="c1"># candidate the first blessed model.</span>
<span class="n">model_resolver</span> <span class="o">=</span> <span class="n">ResolverNode</span><span class="p">(</span>
      <span class="n">instance_name</span><span class="o">=</span><span class="s1">'latest_blessed_model_resolver'</span><span class="p">,</span>
      <span class="n">resolver_class</span><span class="o">=</span><span class="n">latest_blessed_model_resolver</span><span class="o">.</span><span class="n">LatestBlessedModelResolver</span><span class="p">,</span>
      <span class="n">model</span><span class="o">=</span><span class="n">Channel</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">Model</span><span class="p">),</span>
      <span class="n">model_blessing</span><span class="o">=</span><span class="n">Channel</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">ModelBlessing</span><span class="p">))</span>
<span class="n">context</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">model_resolver</span><span class="p">)</span>

<span class="n">evaluator</span> <span class="o">=</span> <span class="n">Evaluator</span><span class="p">(</span>
    <span class="n">examples</span><span class="o">=</span><span class="n">example_gen</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'examples'</span><span class="p">],</span>
    <span class="n">model</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'model'</span><span class="p">],</span>
    <span class="n">baseline_model</span><span class="o">=</span><span class="n">model_resolver</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'model'</span><span class="p">],</span>
    <span class="c1"># Change threshold will be ignored if there is no baseline (first run).</span>
    <span class="n">eval_config</span><span class="o">=</span><span class="n">eval_config</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">evaluator</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's examine the output artifacts of <code>Evaluator</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">evaluator</span><span class="o">.</span><span class="n">outputs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Using the <code>evaluation</code> output we can show the default visualization of global metrics on the entire evaluation set.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">evaluator</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'evaluation'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To see the visualization for sliced evaluation metrics, we can directly call the TensorFlow Model Analysis library.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow_model_analysis</span> <span class="k">as</span> <span class="nn">tfma</span>

<span class="c1"># Get the TFMA output result path and load the result.</span>
<span class="n">PATH_TO_RESULT</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'evaluation'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uri</span>
<span class="n">tfma_result</span> <span class="o">=</span> <span class="n">tfma</span><span class="o">.</span><span class="n">load_eval_result</span><span class="p">(</span><span class="n">PATH_TO_RESULT</span><span class="p">)</span>

<span class="c1"># Show data sliced along feature column trip_start_hour.</span>
<span class="c1">#tfma.view.render_slicing_metrics(</span>
<span class="c1">#    tfma_result, slicing_column='trip_start_hour')</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This visualization shows the same metrics, but computed at every feature value of <code>trip_start_hour</code> instead of on the entire evaluation set.</p>
<p>TensorFlow Model Analysis supports many other visualizations, such as Fairness Indicators and plotting a time series of model performance. To learn more, see <a href="https://www.tensorflow.org/tfx/tutorials/model_analysis/tfma_basic">the tutorial</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Al añadir umbrales a la configuración, podemos ver también la salida de la validación. La presencia de un artifact <code>blessing</code> (bendecido) indica que nuestro modelo pasó la validación. Si esta es la primera validación, el modelo candidato es automáticamente bendecido.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">blessing_uri</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">blessing</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uri</span>
<span class="o">!</span>ls -l <span class="o">{</span>blessing_uri<span class="o">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now can also verify the success by loading the validation result record:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">PATH_TO_RESULT</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'evaluation'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uri</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tfma</span><span class="o">.</span><span class="n">load_validation_result</span><span class="p">(</span><span class="n">PATH_TO_RESULT</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Pusher">
<a class="anchor" href="#Pusher" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pusher<a class="anchor-link" href="#Pusher"> </a>
</h3>
<p>El componente <code>Pusher</code> suele ser el último del pipeline de TFX. Comprueba si se ha pasado la validación, y exporta el modelo al directorio <code>_serving_model_dir</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_serving_model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"./"</span><span class="p">,</span> <span class="s2">"my_serving_model"</span><span class="p">)</span>


<span class="n">pusher</span> <span class="o">=</span> <span class="n">Pusher</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'model'</span><span class="p">],</span>
    <span class="n">model_blessing</span><span class="o">=</span><span class="n">evaluator</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'blessing'</span><span class="p">],</span>
    <span class="n">push_destination</span><span class="o">=</span><span class="n">pusher_pb2</span><span class="o">.</span><span class="n">PushDestination</span><span class="p">(</span>
        <span class="n">filesystem</span><span class="o">=</span><span class="n">pusher_pb2</span><span class="o">.</span><span class="n">PushDestination</span><span class="o">.</span><span class="n">Filesystem</span><span class="p">(</span>
            <span class="n">base_directory</span><span class="o">=</span><span class="n">_serving_model_dir</span><span class="p">)))</span>
<span class="n">context</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">pusher</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Artifacts de salida de <code>Pusher</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pusher</span><span class="o">.</span><span class="n">outputs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>En concreto, <code>Pusher</code> puede exportar el modelo en formato SavedModel:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">push_uri</span> <span class="o">=</span> <span class="n">pusher</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">model_push</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uri</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">saved_model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">push_uri</span><span class="p">)</span>

<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">signatures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Esto concluye el pipeline de TFX</p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="rafaelsf80/notebooks"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/notebooks/natural%20language%20processing/google%20cloud/2021/01/25/tfx-stackoverflow.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/notebooks/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/notebooks/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/notebooks/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Una lista de posts y notebooks prácticos en español sobre inteligencia artificial y aprendizaje profundo.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/rafaelsf80" target="_blank" title="rafaelsf80"><svg class="svg-icon grey"><use xlink:href="/notebooks/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/rafaelsf80" target="_blank" title="rafaelsf80"><svg class="svg-icon grey"><use xlink:href="/notebooks/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
